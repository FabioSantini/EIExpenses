version: '3.8'

services:
  ei-expenses:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      # Application Settings
      NODE_ENV: production
      PORT: 3000
      APP_URL: http://localhost:3000
      APP_NAME: EI-Expenses
      APP_VERSION: 0.1.0
      DEBUG: ${DEBUG:-false}

      # Mock Mode (set to true if you don't have Azure resources)
      USE_MOCK: ${USE_MOCK:-false}

      # Azure SQL Database
      DATABASE_URL: ${DATABASE_URL}

      # Azure Blob Storage
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      AZURE_STORAGE_CONTAINER_NAME: ${AZURE_STORAGE_CONTAINER_NAME:-receipts}

      # Azure AD Authentication
      AZURE_AD_TENANT_ID: ${AZURE_AD_TENANT_ID}
      AZURE_AD_CLIENT_ID: ${AZURE_AD_CLIENT_ID}
      AZURE_AD_CLIENT_SECRET: ${AZURE_AD_CLIENT_SECRET}
      AZURE_AD_ALLOWED_GROUP_ID: ${AZURE_AD_ALLOWED_GROUP_ID}

      # NextAuth
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}

      # OpenAI API
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o}
      OPENAI_MAX_TOKENS: ${OPENAI_MAX_TOKENS:-1000}
      OPENAI_TEMPERATURE: ${OPENAI_TEMPERATURE:-0.2}

      # Google Maps (Public key is OK to be in image, but better as env var)
      NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}

      # Feature Flags
      FEATURE_OCR: ${FEATURE_OCR:-true}
      FEATURE_GOOGLE_MAPS: ${FEATURE_GOOGLE_MAPS:-true}
      FEATURE_EXCEL_EXPORT: ${FEATURE_EXCEL_EXPORT:-true}
      FEATURE_PWA: ${FEATURE_PWA:-false}
      FEATURE_OFFLINE: ${FEATURE_OFFLINE:-false}

      # API Settings
      API_RATE_LIMIT_ENABLED: ${API_RATE_LIMIT_ENABLED:-false}
      API_RATE_LIMIT_REQUESTS: ${API_RATE_LIMIT_REQUESTS:-100}
      API_RATE_LIMIT_WINDOW: ${API_RATE_LIMIT_WINDOW:-60000}

      # CORS Settings
      CORS_ENABLED: ${CORS_ENABLED:-true}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}

      # Excel Export Settings
      EXCEL_TEMPLATE_PATH: ${EXCEL_TEMPLATE_PATH:-./templates/expense-report.xlsx}
      EXCEL_MAX_ROWS: ${EXCEL_MAX_ROWS:-10000}
      EXCEL_INCLUDE_RECEIPTS: ${EXCEL_INCLUDE_RECEIPTS:-true}

      # Prisma
      PRISMA_LOG_LEVEL: ${PRISMA_LOG_LEVEL:-info}

      # Next.js
      NEXT_STRICT_MODE: ${NEXT_STRICT_MODE:-true}
      NEXT_PUBLIC_DEBUG: ${NEXT_PUBLIC_DEBUG:-false}

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits (adjust based on your machine)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G